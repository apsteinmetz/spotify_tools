---
title: "What Type of Song Do I Like?"
output: html_notebook
---

```{r}
library(tidyverse)
library(spotifyr)
library(purrr)
```

There are about 1500 songs that SheilaB has played at least twice. Of those, about 1200 are findable on Spotify.  Missing songs are either not on Spotify, have spellings on the WFMU playlists that differ from what Spotify knows or are non-US releases that are listed in non-English alphabets (e.g. Pizzacato Five).

Once we have the track ID, we can retrieve Spotify's audio features data for each track and do some analysis.



```{r get my saved tracks}
load("data/sb_tracks.rdata")
```


```{r get features of track list, eval=FALSE, include=FALSE}
track_list <-sb_tracks
offset = 0
limit = 100
total = nrow(track_list)
my_saved_features_all <- NULL
repeat {
   my_saved_features_raw <-
      get_track_audio_features(track_list$track.id[(offset+1):(offset+limit)])
   my_saved_features_all <- bind_rows(my_saved_features_raw,my_saved_features_all)
   print(offset)
   offset <- offset + limit
   if (offset >= total) {
      print("All Songs Retrieved")
      break
   }
}
```


```{r wrangle}
pitch_names <- c("C","C#","D","D#","E","F","F#","G","G#","A","A#","B")
mode_names <- c("minor","major")
my_saved_features <- my_saved_features_all %>% rename(track.id = id) %>% 
   select(-c(uri,track_href,analysis_url,type))
my_saved_features$pitch <- as.factor(my_saved_features$key)
levels(my_saved_features$pitch) <- pitch_names
my_saved_features$mode_name <- as.factor(my_saved_features$mode)
levels(my_saved_features$mode_name) <- mode_names
my_features <- left_join(track_list,my_saved_features,by="track.id") %>% 
   unique() 
my_features <- my_features %>% 
   mutate(full_key = paste(pitch,mode_name)) %>% 
   mutate(year_released = as.numeric(str_extract(release_date,"^\\d{4}"))) %>% 
   select(track.id,spot_artist,spot_track,spot_album,track_number,
          release_date,pitch,mode_name,full_key,everything()) %>% 
   na.omit()


save(my_features,file="data/sb_features.rdata")

```

```{r EDA}
summary(my_features)
```
```{r}
library(corrplot)
my_features %>% select(10:24) %>% 
   # mutate(across(contains("date"),as.numeric)) %>% 
   cor() %>% 
   corrplot()
```

```{r}
library(Hmisc)
hist.data.frame(my_features[,10:24])
```


Key is not a great predictor of popularity.
```{r keys others}
my_features %>% 
   mutate(key_color = ifelse(str_detect(pitch,"#"),"black","white")) %>% 
   group_by(full_key) %>% 
   summarise(avg_popularity = mean(popularity)) %>% 
   mutate(key_color = ifelse(str_detect(full_key,"minor"),"black","white")) %>% 
   ggplot(aes(full_key,avg_popularity,fill = key_color)) + geom_col() +
   scale_fill_manual(values = c("black","white")) +
   labs(title = "Keys Other People Like",
        y = "Average Popularity") + 
   theme(panel.background = element_rect(fill="grey"),
         panel.grid = element_line(color = "grey"),
         legend.position = "none",
         axis.text.x = element_text(angle=45,hjust = 1,vjust=1))

```

```{r}
table(my_features[c("pitch","mode_name")]) %>% as_tibble() %>% arrange(desc(n))
```

```{r}
my_features %>% 
   ggplot(aes(mode_name)) + geom_bar()
```

SheilaB show a clear preference for major keys. Happy, happy.
```{r keys me}
my_features %>% 
   mutate(key_color = ifelse(str_detect(full_key,"minor"),"black","white")) %>% 
   group_by(full_key) %>% 
   ggplot(aes(full_key,fill=key_color)) + geom_bar() + 
   scale_fill_manual(values = c("black","white")) +
   labs(title = "Keys SheilaB Likes",
        y = "Count of Plays",
        x = "Dominant Key") + 
   theme(panel.background = element_rect(fill= "#F08080",),
         panel.grid = element_line("#F08080"),
         legend.position = "none",
         axis.text.x = element_text(angle=45,hjust = 1,vjust=1))


```
```{r valence}
my_features %>% ggplot(aes(valence)) + geom_density(fill="orange") +
   labs(title = "SheilaB Plays A Lot of Happy Songs",
        y = "Relative Frequency of Songs",
        x = '<-- SAD - Spotify "Valence" - HAPPY -->') + 
   theme(panel.background = element_rect(fill= "#F08080",),
         panel.grid = element_line("#F08080"),
         axis.text.y = element_blank())
```

```{r danceability}
my_features %>% ggplot(aes(danceability)) + geom_density(fill="orange") +
   labs(title = "SheilaB Likes to Dance, But Not Too Much",
        y = "Relative Frequency of Songs",
        x = 'Spotify "Danceability"') + 
   theme(panel.background = element_rect(fill= "#F08080",),
         panel.grid = element_line("orange"))
```

```{r BPM}
my_features %>% ggplot(aes(tempo)) + geom_density(fill="orange") +
   labs(title = "SheilaB Brings the BPM",
        y = "Relative Frequency of Songs",
        x = 'Beats Per Minute') + 
   theme(panel.background = element_rect(fill= "#F08080",),
         panel.grid = element_line("#F08080"),
         axis.text.y = element_blank())
```
```{r popularity}
my_features %>% ggplot(aes(popularity)) + geom_density(fill="orange") +
   labs(title = "SheilaB Likes the Familiar But Not the Hits",
        y = "Relative Frequency of Songs",
        x = 'Spotify Relative "Popularity"') + 
   theme(panel.background = element_rect(fill= "#F08080",),
         panel.grid= element_line("#F08080"),
         panel.grid.major.x = element_line("orange"),
         axis.text.y = element_blank())
```
```{r year}
my_features %>% ggplot(aes(year_released)) + geom_histogram(binwidth = 1,fill="orange") +
   labs(title = "SheilaB Likes the Late 1960s",
        y = "Count of Songs",
        x = 'Year Released') + 
   annotate("text",x=1932,y=10,label = "Frankie\nCarie") +
   scale_x_continuous(breaks = seq(from=1930,to=2021,by=5)) + 
   theme(panel.background = element_rect(fill= "#F08080",),
         panel.grid= element_line("#F08080"),
         panel.grid.major.x = element_line("orange"))
```

Can we work with a larger list and search by artist since many artists will have multiple plays?

Loop through artists to get albums. TEST just take top two artists
```{r}
all_artists <- all_tracks %>% 
   select(ArtistToken,song) %>% 
   group_by(ArtistToken) %>% 
   unique() %>% 
   nest(songs = song) %>% 
   mutate(song_count = nrow(songs[[1]])) %>% 
   arrange(desc(song_count))


artists <- all_artists$ArtistToken[1:2]

albums_raw <- artists %>% 
   map(function(artist) search_spotify(q=paste0("artist:",artist),type=c("album"),limit = 50))

albums <- albums_raw %>% 
   bind_rows() %>% 
   transmute(album_id = id,album_name = name,artists)  %>% 
   unnest(artists) %>% 
   transmute(album_id,album_name,artist_id = id,artist_name=name)

```
Loop through albums to get tracks

```{r}

#this ain't fast.  We can't submit more than one album at a time
tracks_raw <- albums$album_id %>% map(function(album) get_album_tracks(album,limit = 50))

tracks <- bind_cols(albums,tibble(tracks_raw = tracks_raw)) %>% 
   unnest(tracks_raw) %>% 
   transmute(artist_id,artist_name,album_id,album_name,track_id=id,track_name = name)
   
```


Match tracks to desired songs
```{r}
all_artists[1:2,] %>% 
   unnest(songs) %>% 
   ungroup() %>% 
   transmute(artist_name = ArtistToken, track_name=song) %>% 
   unique() %>% 
   left_join(tracks,by = c("artist_name", "track_name")) %>% 
   na.omit() %>% 
   group_by(artist_name,track_name) %>% 
   slice(1)
```

Get aggregate audio features for top artists.

First, get top artists.
```{r}
load("~/R Projects/wfmu/playlists.Rdata")

sb_top_artists <- playlists %>%
   filter(DJ == "CF") %>% 
   group_by(ArtistToken) %>% 
   summarise(play_count = n()) %>% 
   filter(play_count>11) %>% 
   arrange(desc(play_count))

```
Get audio features
```{r}

```

